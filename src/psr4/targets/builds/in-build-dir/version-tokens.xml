<?xml version="1.0" encoding="UTF-8" ?>

<project>

  <!-- ============================================  -->
  <!-- Version token replacements. -->
  <!-- Applies to `build` target only. -->
  <!-- ============================================  -->

  <target name="-builds-in-build-dir-version-tokens" hidden="true">

    <!-- PHP/JS/CSS/SCSS/BASH token replacements. -->

    <echo msg="Replacing PHP/JS/CSS/SCSS/BASH version tokens in: ${project.basedir}/.~build/${project_slug}" />

    <reflexive>
      <fileSet dir="${project.basedir}/.~build/${project_slug}" caseSensitive="false" defaultExcludes="false">
        <patternSet refId="_git_ignore_pattern_set" />
        <patternSet refId="_alter_ignore_pattern_set" />
        <patternSet refId="_token_pattern_set" />
      </fileSet>
      <filterChain>
        <replaceRegExp>
          <regExp pattern="'[^']*?'([,;]\s*)(#\s*)?\/\/v\/\/$" replace="'${_project_build_version}'$1$2//v//" modifiers="um" />
          <regExp pattern='"[^"]*?"([,;]\s*)(#\s*)?\/\/v\/\/$' replace='"${_project_build_version}"$1$2//v//' modifiers="um" />

          <regExp pattern="'[^']*?'([,;]\s*)(#\s*)?\/\/version\/\/$" replace="'${_project_build_version}'$1$2//version//" modifiers="um" />
          <regExp pattern='"[^"]*?"([,;]\s*)(#\s*)?\/\/version\/\/$' replace='"${_project_build_version}"$1$2//version//' modifiers="um" />

          <regExp pattern="'[^']*?'([,;]\s*)(#\s*)?\/\/os\-required\/\/$" replace="'${project_required_os}'$1$2//os-required//" modifiers="um" />
          <regExp pattern='"[^"]*?"([,;]\s*)(#\s*)?\/\/os\-required\/\/$' replace='"${project_required_os}"$1$2//os-required//' modifiers="um" />

          <regExp pattern="'[^']*?'([,;]\s*)(#\s*)?\/\/php\-required\-version\/\/$" replace="'${project_php_required_version}'$1$2//php-required-version//" modifiers="um" />
          <regExp pattern='"[^"]*?"([,;]\s*)(#\s*)?\/\/php\-required\-version\/\/$' replace='"${project_php_required_version}"$1$2//php-required-version//' modifiers="um" />

          <regExp pattern="'[^']*?'([,;]\s*)(#\s*)?\/\/php\-up\-to\-version\/\/$" replace="'${project_php_tested_up_to_version}'$1$2//php-up-to-version//" modifiers="um" />
          <regExp pattern='"[^"]*?"([,;]\s*)(#\s*)?\/\/php\-up\-to\-version\/\/$' replace='"${project_php_tested_up_to_version}"$1$2//php-up-to-version//' modifiers="um" />

          <regExp pattern="\b[0-9]+([,;]\s*)(#\s*)?\/\/php\-required\-bits\/\/$" replace="${project_php_required_bits}$1$2//php-required-bits//" modifiers="um" />
          <regExp pattern="\barray\s*\([^()]*\)([,;]\s*)(#\s*)?\/\/php\-required\-functions\/\/" replace="array(${_project_php_required_functions})$1$2//php-required-functions//" modifiers="u" />
          <regExp pattern="\barray\s*\([^()]*\)([,;]\s*)(#\s*)?\/\/php\-required\-extensions\/\/" replace="array(${_project_php_required_extensions})$1$2//php-required-extensions//" modifiers="u" />
        </replaceRegExp>
      </filterChain>
    </reflexive>

    <!-- README/CHANGELOG version token replacements. -->

    <echo />

    <echo msg="Replacing README/CHANGELOG version tokens: ${project.basedir}/.~build/${project_slug}" />

    <reflexive>
      <fileSet dir="${project.basedir}/.~build/${project_slug}" caseSensitive="false" defaultExcludes="false">
        <include pattern="README.md" />
        <include pattern="CHANGELOG.md" />
      </fileSet>
      <filterChain>
        <replaceRegExp>
          <regExp pattern="^(#+\s+)\$v$" replace="$1v${_project_build_version}" modifiers="um" />
          <regExp pattern="^(#+\s+)\/\/v\/\/$" replace="$1v${_project_build_version}" modifiers="um" />
          <regExp pattern="^(#+\s+)\/\/version\/\/$" replace="$1v${_project_build_version}" modifiers="um" />
        </replaceRegExp>
      </filterChain>
    </reflexive>

    <!-- WordPress header replacements. -->

    <if>
      <and>
        <isTrue value="${_is_wp_theme_plugin}" />
      </and>
      <then>
        <echo />

        <echo msg="Replacing WP version headers in: ${project.basedir}/.~build/${project_slug}" />

        <reflexive>
          <fileSet dir="${project.basedir}/.~build/${project_slug}" caseSensitive="false" defaultExcludes="false">
            <patternSet refId="_git_ignore_pattern_set" />
            <patternSet refId="_alter_ignore_pattern_set" />
            <patternSet refId="_wp_token_pattern_set" />
          </fileSet>
          <filterChain>
            <replaceRegExp>
              <regExp pattern="^(\s*\*\s*)?Version\:.+$" replace="$1Version: ${_project_build_version}" modifiers="um" />
              <regExp pattern="^(\s*\*\s*)?Stable tag\:.+$" replace="$1Stable tag: ${_project_build_version}" modifiers="um" />

              <regExp pattern="^(\s*\*\s*)?Requires at least\:.+$" replace="$1Requires at least: ${project_wp_required_version}" modifiers="um" />
              <regExp pattern="^(\s*\*\s*)?Tested up to\:.+$" replace="$1Tested up to: ${project_wp_tested_up_to_version}" modifiers="um" />

              <regExp pattern="^(\s*\*\s*)?Requires PHP\:.+$" replace="$1Requires PHP: ${project_php_required_version}" modifiers="um" />
              <regExp pattern="^(\s*\*\s*)?Tested up to PHP\:.+$" replace="$1Tested up to PHP: ${project_php_tested_up_to_version}" modifiers="um" />
            </replaceRegExp>
          </filterChain>
        </reflexive>

        <if>
          <and>
            <isTrue value="${_is_wp_sharks_core_theme_plugin}" />
          </and>
          <then>
            <reflexive>
              <fileSet dir="${project.basedir}/.~build/${project_slug}" caseSensitive="false" defaultExcludes="false">
                <patternSet refId="_git_ignore_pattern_set" />
                <patternSet refId="_alter_ignore_pattern_set" />
                <patternSet refId="_wp_token_pattern_set" />
              </fileSet>
              <filterChain>
                <replaceRegExp>
                  <regExp pattern="^(\s*\*\s*)?Requires WP Sharks Core\:.+$" replace="$1Requires WP Sharks Core: ${project_wp_sharks_core_required_version}" modifiers="um" />
                  <regExp pattern="^(\s*\*\s*)?Tested up to WP Sharks Core\:.+$" replace="$1Tested up to WP Sharks Core: ${project_wp_sharks_core_tested_up_to_version}" modifiers="um" />
                  <regExp pattern="^(\s*\*\s*)?Max compatible WP Sharks Core\:.+$" replace="$1Max compatible WP Sharks Core: ${project_wp_sharks_core_max_compatible_version}" modifiers="um" />
                </replaceRegExp>
              </filterChain>
            </reflexive>
          </then>
        </if>

      </then>
    </if>

    <!-- WordPress token replacements. -->

    <if>
      <and>
        <isTrue value="${_is_wp_theme_plugin}" />
      </and>
      <then>
        <echo />

        <echo msg="Replacing WP version tokens in: ${project.basedir}/.~build/${project_slug}" />

        <reflexive>
          <fileSet dir="${project.basedir}/.~build/${project_slug}" caseSensitive="false" defaultExcludes="false">
            <patternSet refId="_git_ignore_pattern_set" />
            <patternSet refId="_alter_ignore_pattern_set" />
            <patternSet refId="_token_pattern_set" />
          </fileSet>
          <filterChain>
            <replaceRegExp>
              <regExp pattern="'[^']*?'([,;]\s*)(#\s*)?\/\/wp\-required\-version\/\/$" replace="'${project_wp_required_version}'$1$2//wp-required-version//" modifiers="um" />
              <regExp pattern='"[^"]*?"([,;]\s*)(#\s*)?\/\/wp\-required\-version\/\/$' replace='"${project_wp_required_version}"$1$2//wp-required-version//' modifiers="um" />

              <regExp pattern="'[^']*?'([,;]\s*)(#\s*)?\/\/wp\-up\-to\-version\/\/$" replace="'${project_wp_tested_up_to_version}'$1$2//wp-up-to-version//" modifiers="um" />
              <regExp pattern='"[^"]*?"([,;]\s*)(#\s*)?\/\/wp\-up\-to\-version\/\/$' replace='"${project_wp_tested_up_to_version}"$1$2//wp-up-to-version//' modifiers="um" />
            </replaceRegExp>
          </filterChain>
        </reflexive>

        <if>
          <and>
            <isTrue value="${_is_wp_sharks_core_theme_plugin}" />
          </and>
          <then>
            <reflexive>
              <fileSet dir="${project.basedir}/.~build/${project_slug}" caseSensitive="false" defaultExcludes="false">
                <patternSet refId="_git_ignore_pattern_set" />
                <patternSet refId="_alter_ignore_pattern_set" />
                <patternSet refId="_token_pattern_set" />
              </fileSet>
              <filterChain>
                <replaceRegExp>
                  <regExp pattern="'[^']*?'([,;]\s*)(#\s*)?\/\/wp\-sharks\-core\-required\-version\/\/$" replace="'${project_wp_sharks_core_required_version}'$1$2//wp-sharks-core-required-version//" modifiers="um" />
                  <regExp pattern='"[^"]*?"([,;]\s*)(#\s*)?\/\/wp\-sharks\-core\-required\-version\/\/$' replace='"${project_wp_sharks_core_required_version}"$1$2//wp-sharks-core-required-version//' modifiers="um" />

                  <regExp pattern="'[^']*?'([,;]\s*)(#\s*)?\/\/wp\-sharks\-core\-up\-to\-version\/\/$" replace="'${project_wp_sharks_core_tested_up_to_version}'$1$2//wp-sharks-core-up-to-version//" modifiers="um" />
                  <regExp pattern='"[^"]*?"([,;]\s*)(#\s*)?\/\/wp\-sharks\-core\-up\-to\-version\/\/$' replace='"${project_wp_sharks_core_tested_up_to_version}"$1$2//wp-sharks-core-up-to-version//' modifiers="um" />

                  <regExp pattern="'[^']*?'([,;]\s*)(#\s*)?\/\/wp\-sharks\-core\-max\-compatible\-version\/\/$" replace="'${project_wp_sharks_core_max_compatible_version}'$1$2//wp-sharks-core-max-compatible-version//" modifiers="um" />
                  <regExp pattern='"[^"]*?"([,;]\s*)(#\s*)?\/\/wp\-sharks\-core\-max\-compatible\-version\/\/$' replace='"${project_wp_sharks_core_max_compatible_version}"$1$2//wp-sharks-core-max-compatible-version//' modifiers="um" />
                </replaceRegExp>
              </filterChain>
            </reflexive>
          </then>
        </if>

      </then>
    </if>

  </target>

</project>
