<?xml version="1.0" encoding="UTF-8" ?>

  <project name="lite">

    <!-- ============================================  -->
    <!-- Lite generation. -->
    <!-- ============================================  -->

    <target name="-lite" hidden="true">

      <if>
        <and>
          <not>
            <isset property="is_lite_build" />
          </not>
          <istrue value="${_has_lite_build_props}" />
        </and>
        <then>
          <!-- Prepare for lite generation. -->

          <echo msg="Deleting previous: ${project.basedir}/.~build/${project_lite_slug}" />

          <delete dir="${project.basedir}/.~build/${project_lite_slug}" includeemptydirs="true" quiet="true" />

          <echo msg="Creating: ${project.basedir}/.~build/${project_lite_slug}" />

          <copy todir="${project.basedir}/.~build/${project_lite_slug}">
            <fileset dir="${project.basedir}">
              <exclude pattern=".~build/**" />
              <exclude pattern="**/${project_slug}.pot" />
            </fileset>
          </copy>

          <delete>
            <fileset dir="${project.basedir}/.~build/${project_lite_slug}" casesensitive="false">
              <patternset refid="_text_based_patternset" />
              <containsregexp expression="\/\*\!?\[pro strip\-file\-from\=['&quot;]lite['&quot;]\]\*\/" />
            </fileset>
          </delete>

          <echo msg="------------------------------------" />

          <!-- WordPress plugin file rename. -->

          <if>
            <and>
              <istrue value="${_is_wp_theme_plugin}" />
              <available file="${project.basedir}/.~build/${project_lite_slug}/${project_slug}.php" />
            </and>
            <then>
              <echo msg="Renaming: ${project.basedir}/.~build/${project_lite_slug}/${project_slug}.php" />

              <move file="${project.basedir}/.~build/${project_lite_slug}/${project_slug}.php" tofile="${project.basedir}/.~build/${project_lite_slug}/${project_lite_slug}.php" />

              <echo msg="------------------------------------" />
            </then>
            <else>
              <echo msg="N/A: skipping WP plugin file rename in lite variation." />

              <echo msg="------------------------------------" />
            </else>
          </if>

          <!-- WordPress token replacements. -->

          <if>
            <and>
              <istrue value="${_is_wp_theme_plugin}" />
            </and>
            <then>
              <echo msg="Replacing WP headers in: ${project.basedir}/.~build/${project_lite_slug}" />

              <reflexive>
                <fileset dir="${project.basedir}/.~build/${project_lite_slug}" casesensitive="false">
                  <include pattern="readme.txt" />
                  <include pattern="plugin.php" />
                  <include pattern="${project_lite_slug}.php" />
                  <include pattern="uninstall.php" />
                  <include pattern="functions.php" />
                  <include pattern="style.css" />
                </fileset>
                <filterchain>
                  <replaceregexp>
                    <regexp pattern="^\=\=\=.+?\=\=\=\n" replace="=== ${project_lite_title} ===${line.separator}" modifiers="u" />
                    <regexp pattern="^Theme Name\:.+$" replace="Theme Name: ${project_lite_title}" modifiers="um" />
                    <regexp pattern="^Plugin Name\:.+$" replace="Plugin Name: ${project_lite_title}" modifiers="um" />
                  </replaceregexp>
                </filterchain>
              </reflexive>

              <echo msg="------------------------------------" />
            </then>
            <else>
              <echo msg="N/A: skipping WP headers in lite variation." />

              <echo msg="------------------------------------" />
            </else>
          </if>

          <!-- Other token replacements. -->

          <echo msg="Replacing other tokens in: ${project.basedir}/.~build/${project_lite_slug}" />

          <reflexive>
            <fileset dir="${project.basedir}/.~build/${project_lite_slug}" casesensitive="false">
              <include pattern="readme.md" />
            </fileset>
            <filterchain>
              <replaceregexp>
                <regexp pattern="^##.+?\n" replace="## ${project_lite_title}${line.separator}" modifiers="u" />
              </replaceregexp>
            </filterchain>
          </reflexive>

          <echo msg="------------------------------------" />

          <!-- Namespace replacements. -->

          <echo msg="Changing namespace in: ${project.basedir}/.~build/${project_lite_slug}" />

          <reflexive>
            <fileset dir="${project.basedir}/.~build/${project_lite_slug}" casesensitive="false">
              <exclude pattern="src/vendor/**" />

              <include pattern="*.php" />
              <include pattern="**/**.php" />
              <include pattern="*.x-php" />
              <include pattern="**/**.x-php" />
              <include pattern="${project_lite_alter_namespace_in_other_files_pattern}" />
            </fileset>
            <filterchain>
              <replaceregexp>
                <regexp pattern="\b(namespace|use)\s+${project_namespace}\b" replace="\1 ${project_lite_namespace}" modifiers="u" />
              </replaceregexp>
            </filterchain>
          </reflexive>

          <echo msg="------------------------------------" />

          <!-- Composer replacements. -->

          <if>
            <and>
              <available file="${project.basedir}/.~build/${project_lite_slug}/composer.json" />
            </and>
            <then>
              <echo msg="Modifying composer.json: ${project.basedir}/.~build/${project_lite_slug}/composer.json" />

              <php expression="addslashes(addslashes('${project_namespace}'))" returnproperty="_project_namespace_slashes" />
              <php expression="addslashes(addslashes('${project_lite_namespace}'))" returnproperty="_project_lite_namespace_slashes" />

              <reflexive>
                <fileset dir="${project.basedir}/.~build/${project_lite_slug}" casesensitive="false">
                  <include pattern="composer.json" />
                </fileset>
                <filterchain>
                  <replaceregexp>
                    <regexp pattern="\b${project_slug}\b" replace="${project_lite_slug}" modifiers="u" />
                    <regexp pattern="&quot;${_project_namespace_slashes}\\\\" replace="&quot;${_project_lite_namespace_slashes}\\\\" modifiers="u" />
                  </replaceregexp>
                </filterchain>
              </reflexive>

              <echo msg="------------------------------------" />
            </then>
            <else>
              <echo msg="N/A: skipping; composer.json does not exist in lite variation." />

              <echo msg="------------------------------------" />
            </else>
          </if>

          <!-- Strip pro tokens. -->

          <echo msg="Stripping pro tokens from: ${project.basedir}/.~build/${project_lite_slug}" />

          <reflexive>
            <fileset dir="${project.basedir}/.~build/${project_lite_slug}" casesensitive="false">
              <patternset refid="_text_based_patternset" />
            </fileset>
            <filterchain>
              <replaceregexp>
                <regexp pattern="\/\*\!\[pro strip\-from\=['&quot;]lite['&quot;]\]\*\/(?:.*?)\/\*\!\[\/pro\]\*\/" replace="" modifiers="us" />
                <regexp pattern="\/\*\[pro strip\-from\=['&quot;]lite['&quot;]\]\*\/(?:.*?)\/\*\[\/pro\]\*\/" replace="" modifiers="us" />
              </replaceregexp>
            </filterchain>
          </reflexive>

          <echo msg="------------------------------------" />

          <!-- Convert text-domain references to string literals (for translate.wordpress.org). -->

          <if>
            <and>
              <istrue value="${_is_wp_theme_plugin}" />
              <istrue value="${project_lite_text_domain_regex_replacement_pattern}" />
            </and>
            <then>
              <echo msg="Converting text-domain references to string literals in: ${project.basedir}/.~build/${project_lite_slug}" />

              <reflexive>
                <fileset dir="${project.basedir}/.~build/${project_lite_slug}" casesensitive="false">
                  <exclude pattern="src/vendor/**" />

                  <include pattern="*.php" />
                  <include pattern="**/**.php" />
                </fileset>
                <filterchain>
                  <replaceregexp>
                    <regexp pattern="(,\s*)(${project_lite_text_domain_regex_replacement_pattern})(\s*\))" replace="$1'${_project_text_domain}'$3" modifiers="u" />
                  </replaceregexp>
                </filterchain>
              </reflexive>

              <echo msg="------------------------------------" />
            </then>
            <else>
              <echo msg="N/A: skipping WP text-domain references to string literals." />

              <echo msg="------------------------------------" />
            </else>
          </if>

          <!-- Modify build properties; i.e., swap w/ lite property values. -->

          <echo msg="Modifying lite build properties: ${project.basedir}/.~build/${project_lite_slug}/.build.props" />

          <reflexive>
            <fileset dir="${project.basedir}/.~build/${project_lite_slug}" casesensitive="false">
              <include pattern=".build.props" />
            </fileset>
            <filterchain>
              <replaceregexp>
                <regexp pattern="^project_title\s+.*$" replace="" modifiers="um" />
                <regexp pattern="^project_slug\s+.*$" replace="" modifiers="um" />

                <regexp pattern="^project_namespace\s+.*$" replace="" modifiers="um" />
                <regexp pattern="^project_sub_namespace\s+.*$" replace="" modifiers="um" />

                <regexp pattern="^project_other_phar_fileset_exclusions\s+.*$" replace="" modifiers="um" />
                <regexp pattern="^project_other_zip_tgz_fileset_exclusions\s+.*$" replace="" modifiers="um" />

                <regexp pattern="^project_lite_title(\s+)" replace="project_title\1" modifiers="um" />
                <regexp pattern="^project_lite_slug(\s+)" replace="project_slug\1" modifiers="um" />

                <regexp pattern="^project_lite_namespace(\s+)" replace="project_namespace\1" modifiers="um" />
                <regexp pattern="^project_lite_sub_namespace(\s+)" replace="project_sub_namespace\1" modifiers="um" />

                <regexp pattern="^project_lite_other_phar_fileset_exclusions(\s+)" replace="project_other_phar_fileset_exclusions\1" modifiers="um" />
                <regexp pattern="^project_lite_other_zip_tgz_fileset_exclusions(\s+)" replace="project_other_zip_tgz_fileset_exclusions\1" modifiers="um" />
              </replaceregexp>
            </filterchain>
          </reflexive>

          <echo msg="------------------------------------" />

          <!-- Build lite variation now. -->

          <echo msg="Building lite variation from: ${project.basedir}/.~build/${project_lite_slug}/build.xml" />

          <phing phingfile="${project.basedir}/.~build/${project_lite_slug}/build.xml" inheritall="false" inheritrefs="false" haltonfailure="true">
            <property name="is_lite_build" value="true" />
          </phing>

        </then>

        <else>
          <echo msg="N/A: skipping lite variation sub-routines." />

          <echo msg="------------------------------------" />
        </else>
      </if>

    </target>

  </project>
